<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Wildjammer Ship</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative&family=Space+Grotesk&family=Spectral&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="spelljammer-style.css">
    <script src="wildjammer-data.js"></script>
    <script src="ship-class.js"></script>
    <style>
        .editable:hover {
            background-color: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        .popup {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 5px;
            z-index: 1000;
        }
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
    </style>
</head>
<body class="light-mode">
    <div class="cosmic-dust"></div>
    <div class="container constellation-bg">
        <div class="header-container">
            <a href="index.html" class="magical-glow">Back to Ship List</a>
            <div class="button-container">
                <button id="editModeToggle" class="magical-glow">Toggle Edit Mode</button>
                <button id="toggleDarkMode" class="magical-glow">Toggle Dark Mode</button>
            </div>
        </div>

        <div id="shipSheet" class="ship-card">
            <div class="grid-3-col">
                <div class="col-span-2">
                    <h1 id="shipName" class="astral-text editable">Ship Name</h1>
                </div>
                <div>
                    <p>Model: <span id="shipModel"></span></p>
                    <p>Size Classification: <span id="sizeClassification"></span></p>
                </div>
            </div>

            <div class="grid-3-col">
                <div class="ship-card">
                    <h2 class="astral-text">Crew</h2>
                    <ul>
                        <li>Captain: <span id="captain" class="editable"></span></li>
                        <li>Helmsman: <span id="helmsman" class="editable"></span></li>
                        <li>Boatswain: <span id="boatswain" class="editable"></span></li>
                        <li>Gunner 1: <span id="gunner1" class="editable"></span></li>
                        <li>Gunner 2: <span id="gunner2" class="editable"></span></li>
                        <li>Gunner 3: <span id="gunner3" class="editable"></span></li>
                        <li>Fighter Helmsman 1: <span id="fighterHelmsman1" class="editable"></span></li>
                        <li>Fighter Helmsman 2: <span id="fighterHelmsman2" class="editable"></span></li>
                        <li>Fighter Helmsman 3: <span id="fighterHelmsman3" class="editable"></span></li>
                    </ul>
                </div>
                <div class="col-span-2">
                    <div class="grid-3-col">
                        <div class="ship-card text-center">
                            <h3 class="astral-text">Maneuverability</h3>
                            <p id="maneuverability" class="editable">-</p>
                        </div>
                        <div class="ship-card text-center">
                            <h3 class="astral-text">Tactical Speed</h3>
                            <p id="tacticalSpeed" class="editable">-</p>
                        </div>
                        <div class="ship-card text-center">
                            <h3 class="astral-text">Hover Speed</h3>
                            <p id="hoverSpeed" class="editable">-</p>
                        </div>
                    </div>
                    <div class="grid-3-col">
                        <div class="ship-card text-center">
                            <h3 class="astral-text">Bulwark Points</h3>
                            <p id="bulwarkPoints" class="editable">-</p>
                        </div>
                        <div class="ship-card text-center">
                            <h3 class="astral-text">Hull Points</h3>
                            <div class="hull-points-control">
                                <button id="decreaseHP" class="magical-glow">-</button>
                                <input type="number" id="hullPoints" class="steampunk-input" value="0">
                                <button id="increaseHP" class="magical-glow">+</button>
                            </div>
                        </div>
                        <div class="ship-card text-center">
                            <h3 class="astral-text">Armor Class</h3>
                            <p id="armorClass" class="editable">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h2 class="astral-text">Helm</h2>
                <div id="helmInfo" class="ship-card">
                    <h3 id="helmName" class="astral-text">-</h3>
                    <p id="helmDescription">-</p>
                </div>
            </div>

            <div class="grid-2-col">
                <div>
                    <h2 class="astral-text">Crew Complement</h2>
                    <table class="w-full">
                        <thead>
                            <tr>
                                <th>Type of Crew</th>
                                <th>#</th>
                                <th>Rate</th>
                                <th>Per Month</th>
                            </tr>
                        </thead>
                        <tbody id="crewComplementTable">
                            <!-- Crew complement rows will be added here dynamically -->
                        </tbody>
                    </table>
                </div>
                <div>
                    <h2 class="astral-text">Modules</h2>
                    <ul id="modulesList">
                        <!-- Modules will be added here dynamically -->
                    </ul>
                    <button id="addModule" class="magical-glow">Add Module</button>
                </div>
            </div>

            <div class="mb-4">
                <h2 class="astral-text">Weapons</h2>
                <table class="w-full">
                    <thead>
                        <tr>
                            <th>Weapon</th>
                            <th>Attack Bonus</th>
                            <th>Mega Damage</th>
                            <th>Range/Facing</th>
                            <th>Hull Points</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="weaponsList">
                        <!-- Weapons will be added here dynamically -->
                    </tbody>
                </table>
                <button id="addWeapon" class="magical-glow">Add Weapon</button>
            </div>

            <div class="mb-4">
                <h2 class="astral-text">Ship Features and Upgrades</h2>
                <ul id="upgradesList">
                    <!-- Upgrades will be added here dynamically -->
                </ul>
                <button id="addUpgrade" class="magical-glow">Add Upgrade</button>
            </div>

            <div class="mb-4">
                <h2 class="astral-text">Cargo Storage</h2>
                <div class="grid-4-col">
                    <div>
                        <label for="copperInput">Copper:</label>
                        <input type="number" id="copperInput" class="steampunk-input" value="0">
                    </div>
                    <div>
                        <label for="silverInput">Silver:</label>
                        <input type="number" id="silverInput" class="steampunk-input" value="0">
                    </div>
                    <div>
                        <label for="goldInput">Gold:</label>
                        <input type="number" id="goldInput" class="steampunk-input" value="0">
                    </div>
                    <div>
                        <label for="platinumInput">Platinum:</label>
                        <input type="number" id="platinumInput" class="steampunk-input" value="0">
                    </div>
                </div>
                <div class="mt-4">
                    <label for="cargoItems">Cargo Items:</label>
                    <textarea id="cargoItems" class="steampunk-input" rows="4"></textarea>
                </div>
            </div>
        </div>
    </div>

    <div id="popup" class="popup">
        <h2 class="astral-text">Dice Roll Result</h2>
        <p id="rollResult"></p>
        <button id="closePopup" class="magical-glow">Close</button>
    </div>

    <div id="overlay" class="overlay"></div>

    <div id="moduleDropdown" class="dropdown-hidden">
        <select id="moduleSelect" class="steampunk-input">
            <!-- Options will be populated dynamically -->
        </select>
        <div class="dropdown-actions">
            <button id="confirmAddModule" class="magical-glow">Add</button>
            <button id="cancelAddModule" class="magical-glow">Cancel</button>
        </div>
    </div>

    <div id="weaponDropdown" class="dropdown-hidden">
        <select id="weaponSelect" class="steampunk-input">
            <!-- Options will be populated dynamically -->
        </select>
        <div class="dropdown-actions">
            <button id="confirmAddWeapon" class="magical-glow">Add</button>
            <button id="cancelAddWeapon" class="magical-glow">Cancel</button>
        </div>
    </div>

    <div id="upgradeDropdown" class="dropdown-hidden">
        <select id="upgradeSelect" class="steampunk-input">
            <!-- Options will be populated dynamically -->
        </select>
        <div class="dropdown-actions">
            <button id="confirmAddUpgrade" class="magical-glow">Add</button>
            <button id="cancelAddUpgrade" class="magical-glow">Cancel</button>
        </div>
    </div>

    <script>
        let currentShip;
        let editMode = false;
    
        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const shipId = urlParams.get('id');
            loadShip(shipId);
    
            document.getElementById('editModeToggle').addEventListener('click', toggleEditMode);
            document.getElementById('toggleDarkMode').addEventListener('click', toggleDarkMode);
            document.getElementById('decreaseHP').addEventListener('click', () => adjustHullPoints(-1));
            document.getElementById('increaseHP').addEventListener('click', () => adjustHullPoints(1));
            document.getElementById('addModule').addEventListener('click', showModuleDropdown);
            document.getElementById('addWeapon').addEventListener('click', showWeaponDropdown);
            document.getElementById('addUpgrade').addEventListener('click', showUpgradeDropdown);
            document.getElementById('closePopup').addEventListener('click', closePopup);
    
            document.getElementById('confirmAddModule').addEventListener('click', confirmAddModule);
            document.getElementById('cancelAddModule').addEventListener('click', hideModuleDropdown);
            document.getElementById('confirmAddWeapon').addEventListener('click', confirmAddWeapon);
            document.getElementById('cancelAddWeapon').addEventListener('click', hideWeaponDropdown);
            document.getElementById('confirmAddUpgrade').addEventListener('click', confirmAddUpgrade);
            document.getElementById('cancelAddUpgrade').addEventListener('click', hideUpgradeDropdown);
    
            // Add event listeners for cargo inputs
            ['copperInput', 'silverInput', 'goldInput', 'platinumInput', 'cargoItems'].forEach(id => {
                document.getElementById(id).addEventListener('change', saveShipChanges);
            });
    
            // Populate dropdowns
            populateDropdown('moduleSelect', wildjammerData.modules);
            populateDropdown('weaponSelect', wildjammerData.weapons);
            populateDropdown('upgradeSelect', wildjammerData.upgrades);

            // Initialize the page
            window.initializePage();
        });   

        function loadShip(shipId) {
            const ships = JSON.parse(localStorage.getItem('wildjammerShips')) || {};
            const shipData = ships[shipId];
            if (shipData) {
                currentShip = window.createShip(shipData);
                console.log('Loaded ship:', currentShip);
                
                // Ensure weaponModifiers is initialized
                currentShip.weaponModifiers = currentShip.weaponModifiers || {};
                
                // Reapply all upgrades
                currentShip.upgrades.forEach(upgradeKey => {
                    applyUpgradeEffect(upgradeKey, true);
                });
                updateShipDisplay();
            } else {
                console.error('Ship not found in localStorage');
                window.location.href = 'create-ship.html';
            }
        }
    
        function updateShipDisplay() {
            document.getElementById('shipName').textContent = currentShip.name;
            document.getElementById('shipModel').textContent = currentShip.hullType;
            document.getElementById('sizeClassification').textContent = `${currentShip.size[0]}x${currentShip.size[1]}`;
            document.getElementById('captain').textContent = currentShip.captain;
            document.getElementById('helmsman').textContent = currentShip.helmsman;
            document.getElementById('boatswain').textContent = currentShip.boatswain;
            document.getElementById('gunner1').textContent = currentShip.gunner1;
            document.getElementById('gunner2').textContent = currentShip.gunner2;
            document.getElementById('gunner3').textContent = currentShip.gunner3;
            document.getElementById('fighterHelmsman1').textContent = currentShip.fighterHelmsman1;
            document.getElementById('fighterHelmsman2').textContent = currentShip.fighterHelmsman2;
            document.getElementById('fighterHelmsman3').textContent = currentShip.fighterHelmsman3;
            document.getElementById('maneuverability').textContent = currentShip.maneuverability;
            const gridMovement = Math.floor(currentShip.speed / 500);
            document.getElementById('tacticalSpeed').textContent = `${currentShip.speed} (${gridMovement} grids)`;
            document.getElementById('hoverSpeed').textContent = "20 mph";
            document.getElementById('bulwarkPoints').textContent = currentShip.bp;
            document.getElementById('hullPoints').value = currentShip.hp;
            document.getElementById('armorClass').textContent = currentShip.ac;
    
            // Update helm information
            const helmInfo = wildjammerData.helms[currentShip.helmType];
            document.getElementById('helmName').textContent = helmInfo.name;
            document.getElementById('helmDescription').textContent = helmInfo.description;
    
            // Update weapons list
            updateWeaponsList();
    
            // Update modules list
            updateModulesList();
    
            // Update upgrades list
            updateUpgradesList();
    
            // Update cargo information
            document.getElementById('copperInput').value = currentShip.cargo.copper;
            document.getElementById('silverInput').value = currentShip.cargo.silver;
            document.getElementById('goldInput').value = currentShip.cargo.gold;
            document.getElementById('platinumInput').value = currentShip.cargo.platinum;
            document.getElementById('cargoItems').value = currentShip.cargo.items;

            updateDynamicClasses();
        }

        function updateWeaponsList() {
            console.log('Updating weapons list:', currentShip.weapons);
            const weaponsList = document.getElementById('weaponsList');
            weaponsList.innerHTML = '';
            
            currentShip.weapons.forEach((weaponKey, index) => {
                const weapon = wildjammerData.weapons[weaponKey];
                if (weapon) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="text-left py-2">${weapon.name}</td>
                        <td class="text-center py-2">
                            <input type="number" class="steampunk-input weapon-to-hit" value="${currentShip.weaponModifiers?.[weaponKey]?.toHit || 0}" data-index="${index}">
                        </td>
                        <td class="text-center py-2">
                            ${weapon.damage} + 
                            <input type="number" class="steampunk-input weapon-damage-modifier" value="${currentShip.weaponModifiers?.[weaponKey]?.damage || 0}" data-index="${index}">
                        </td>
                        <td class="text-center py-2">${weapon.range.normal}/${weapon.range.long}</td>
                        <td class="text-center py-2">
                            <div class="flex items-center justify-center">
                                <button class="magical-glow" onclick="adjustWeaponHP(${index}, -1)">-</button>
                                <input type="number" class="steampunk-input weapon-hp" value="${currentShip.weaponModifiers?.[weaponKey]?.hp || 10}" data-index="${index}" readonly>
                                <button class="magical-glow" onclick="adjustWeaponHP(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="text-center py-2">
                            <button class="magical-glow" onclick="rollWeaponAttack(${index})">Roll</button>
                            <button class="magical-glow" onclick="removeWeapon(${index})">Remove</button>
                        </td>
                    `;
                    weaponsList.appendChild(row);
                } else {
                    console.error(`Weapon not found: ${weaponKey}`);
                }
            });
            updateDynamicClasses();
        }

        function adjustWeaponHP(index, amount) {
            const weaponKey = currentShip.weapons[index];
            if (!currentShip.weaponModifiers) currentShip.weaponModifiers = {};
            if (!currentShip.weaponModifiers[weaponKey]) currentShip.weaponModifiers[weaponKey] = {};
            currentShip.weaponModifiers[weaponKey].hp = (currentShip.weaponModifiers[weaponKey].hp || 10) + amount;
            updateWeaponsList();
            saveShipChanges();
        }

        function updateModulesList() {
            console.log('Updating modules list:', currentShip.modules);
            const modulesList = document.getElementById('modulesList');
            modulesList.innerHTML = '';
            currentShip.modules.forEach((moduleKey, index) => {
                const module = wildjammerData.modules[moduleKey];
                if (module) {
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${module.name}</strong>
                        <p>${module.description}</p>
                        ${module.uses ? `
                            <div class="module-uses" data-index="${index}">
                                <label>Uses: 
                                    <input type="number" class="steampunk-input module-use-count" 
                                           value="${currentShip.moduleUses?.[moduleKey] || 0}" 
                                           min="0" max="${module.uses.max}" data-index="${index}">
                                    / ${module.uses.max} per ${module.uses.per}
                                </label>
                            </div>
                        ` : ''}
                        <button class="magical-glow" onclick="removeModule(${index})">Remove</button>
                    `;
                    modulesList.appendChild(li);
                } else {
                    console.error(`Module not found: ${moduleKey}`);
                }
            });
            updateDynamicClasses();
        }

        function updateUpgradesList() {
            console.log('Updating upgrades list:', currentShip.upgrades);
            const upgradesList = document.getElementById('upgradesList');
            upgradesList.innerHTML = '';
            currentShip.upgrades.forEach((upgradeKey, index) => {
                const upgrade = wildjammerData.upgrades[upgradeKey];
                if (upgrade) {
                    const li = document.createElement('li');
                    li.className = 'mb-4';
                    li.innerHTML = `
                        <strong class="block mb-1">${upgrade.name}</strong>
                        <p class="mb-2">${upgrade.description}</p>
                        <button class="magical-glow" onclick="removeUpgrade(${index})">Remove</button>
                    `;
                    upgradesList.appendChild(li);
                } else {
                    console.error(`Upgrade not found: ${upgradeKey}`);
                }
            });
            updateDynamicClasses();
        }
    
        function toggleEditMode() {
            editMode = !editMode;
            document.querySelectorAll('.editable').forEach(el => {
                el.contentEditable = editMode;
            });
            document.getElementById('editModeToggle').textContent = editMode ? 'Save Changes' : 'Toggle Edit Mode';
            if (!editMode) {
                saveShipChanges();
            }
        }
    
        function adjustHullPoints(amount) {
            const hullPointsInput = document.getElementById('hullPoints');
            hullPointsInput.value = parseInt(hullPointsInput.value) + amount;
            saveShipChanges();
        }
    
        function removeModule(index) {
            currentShip.removeModule(index);
            updateModulesList();
            saveShipChanges();
        }
    
        function removeWeapon(index) {
            currentShip.removeWeapon(index);
            updateWeaponsList();
            saveShipChanges();
        }
    
        function removeUpgrade(index) {
            const upgradeKey = currentShip.upgrades[index];
            currentShip.upgrades.splice(index, 1); // Remove the upgrade from the array
            applyUpgradeEffect(upgradeKey, false);
            updateUpgradesList();
            updateShipDisplay();
            saveShipChanges();
        }
    
        function applyUpgradeEffect(upgradeKey, isAdding) {
            const upgrade = wildjammerData.upgrades[upgradeKey];
            if (upgrade && upgrade.effect) {
                if (isAdding) {
                    upgrade.effect(currentShip);
                } else {
                    // Reverse the effect when removing
                    const reverseEffect = (ship) => {
                        switch (upgrade.name) {
                            case "Enchanted Hull":
                                ship.ac -= 1;
                                break;
                            case "Reinforced Hull":
                                ship.hp -= 16;
                                break;
                            case "Adaptable Sails":
                                ship.maneuverability -= 45;
                                break;
                            case "Gliding Sails":
                                ship.speed -= 500;
                                break;
                            case "Reinforced Bulwark":
                                ship.bp -= 8;
                                break;
                            // Add cases for other upgrades that modify stats
                            default:
                                console.warn(`No reverse effect defined for upgrade: ${upgrade.name}`);
                        }
                    };
                    reverseEffect(currentShip);
                }
            }
            console.log('Applied upgrade effect:', upgradeKey, isAdding, currentShip);
            updateShipDisplay(); // Ensure the display is updated after applying/removing upgrades
        }
    
        function rollWeaponAttack(index) {
            const weapon = wildjammerData.weapons[currentShip.weapons[index]];
            const toHitModifier = parseInt(document.querySelector(`.weapon-to-hit[data-index="${index}"]`).value) || 0;
            const damageModifier = parseInt(document.querySelector(`.weapon-damage-modifier[data-index="${index}"]`).value) || 0;
    
            const toHitRoll = Math.floor(Math.random() * 20) + 1;
            const totalToHit = toHitRoll + toHitModifier;
    
            const damageRoll = rollDice(weapon.damage);
            const totalDamage = damageRoll + damageModifier;
    
            const result = `To hit: ${toHitRoll} + ${toHitModifier} = ${totalToHit}<br>Damage: ${damageRoll} + ${damageModifier} = ${totalDamage} ${weapon.type} damage`;
    
            showPopup(result);
        }
    
        function rollDice(diceNotation) {
            const [count, sides] = diceNotation.split('d').map(Number);
            let total = 0;
            for (let i = 0; i < count; i++) {
                total += Math.floor(Math.random() * sides) + 1;
            }
            return total;
        }
    
        function showPopup(content) {
            document.getElementById('rollResult').innerHTML = content;
            document.getElementById('popup').style.display = 'block';
            document.getElementById('overlay').style.display = 'block';
        }
    
        function closePopup() {
            document.getElementById('popup').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
    
        function saveShipChanges() {
            // Update currentShip object with edited values
            currentShip.name = document.getElementById('shipName').textContent;
            currentShip.captain = document.getElementById('captain').textContent;
            currentShip.helmsman = document.getElementById('helmsman').textContent;
            currentShip.boatswain = document.getElementById('boatswain').textContent;
            currentShip.gunner1 = document.getElementById('gunner1').textContent;
            currentShip.gunner2 = document.getElementById('gunner2').textContent;
            currentShip.gunner3 = document.getElementById('gunner3').textContent;
            currentShip.fighterHelmsman1 = document.getElementById('fighterHelmsman1').textContent;
            currentShip.fighterHelmsman2 = document.getElementById('fighterHelmsman2').textContent;
            currentShip.fighterHelmsman3 = document.getElementById('fighterHelmsman3').textContent;
            currentShip.maneuverability = parseInt(document.getElementById('maneuverability').textContent);
            currentShip.speed = parseInt(document.getElementById('tacticalSpeed').textContent.split(' ')[0]); // Extract the speed value
            currentShip.bp = parseInt(document.getElementById('bulwarkPoints').textContent);
            currentShip.hp = parseInt(document.getElementById('hullPoints').value);
            currentShip.ac = parseInt(document.getElementById('armorClass').textContent);
        
            currentShip.cargo = {
                copper: parseInt(document.getElementById('copperInput').value) || 0,
                silver: parseInt(document.getElementById('silverInput').value) || 0,
                gold: parseInt(document.getElementById('goldInput').value) || 0,
                platinum: parseInt(document.getElementById('platinumInput').value) || 0,
                items: document.getElementById('cargoItems').value
            };
        
            // Save weapon modifiers and HP
            currentShip.weapons.forEach((weaponKey, index) => {
                const toHitModifier = parseInt(document.querySelector(`.weapon-to-hit[data-index="${index}"]`).value) || 0;
                const damageModifier = parseInt(document.querySelector(`.weapon-damage-modifier[data-index="${index}"]`).value) || 0;
                const hpInput = document.querySelector(`.weapon-hp[data-index="${index}"]`);
                const hp = parseInt(hpInput.value) || 10;
                if (!currentShip.weaponModifiers) currentShip.weaponModifiers = {};
                if (!currentShip.weaponModifiers[weaponKey]) currentShip.weaponModifiers[weaponKey] = {};
                currentShip.weaponModifiers[weaponKey] = { toHit: toHitModifier, damage: damageModifier, hp: hp };
            });
        
            // Save module uses
            if (!currentShip.moduleUses) currentShip.moduleUses = {};
            currentShip.modules.forEach((moduleKey, index) => {
                const module = wildjammerData.modules[moduleKey];
                if (module && module.uses) {
                    const useCountInput = document.querySelector(`.module-use-count[data-index="${index}"]`);
                    const usedCount = parseInt(useCountInput.value) || 0;
                    currentShip.moduleUses[moduleKey] = usedCount;
                }
            });
        
            // Save updated ship to localStorage
            const ships = JSON.parse(localStorage.getItem('wildjammerShips')) || {};
            ships[currentShip.id] = currentShip.toJSON();
            localStorage.setItem('wildjammerShips', JSON.stringify(ships));
            console.log('Ship changes saved');
        }
        
        function populateDropdown(selectId, data) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            for (const [key, value] of Object.entries(data)) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = value.name;
                select.appendChild(option);
            }
        }
        
        function showModuleDropdown() {
            document.getElementById('moduleDropdown').style.display = 'block';
        }
    
        function hideModuleDropdown() {
            document.getElementById('moduleDropdown').style.display = 'none';
        }
        
        function confirmAddModule() {
            const moduleKey = document.getElementById('moduleSelect').value;
            if (moduleKey && wildjammerData.modules[moduleKey]) {
                currentShip.addModule(moduleKey);
                updateModulesList();
                saveShipChanges();
                hideModuleDropdown();
            } else {
                alert('Invalid module selection');
            }
        }
    
        function showWeaponDropdown() {
            document.getElementById('weaponDropdown').style.display = 'block';
        }
    
        function hideWeaponDropdown() {
            document.getElementById('weaponDropdown').style.display = 'none';
        }
        
        function confirmAddWeapon() {
            const weaponKey = document.getElementById('weaponSelect').value;
            if (weaponKey && wildjammerData.weapons[weaponKey]) {
                currentShip.addWeapon(weaponKey);
                updateWeaponsList();
                saveShipChanges();
                hideWeaponDropdown();
            } else {
                alert('Invalid weapon selection');
            }
        }
    
        function showUpgradeDropdown() {
            document.getElementById('upgradeDropdown').style.display = 'block';
        }
    
        function hideUpgradeDropdown() {
            document.getElementById('upgradeDropdown').style.display = 'none';
        }
        
        function confirmAddUpgrade() {
            const upgradeKey = document.getElementById('upgradeSelect').value;
            if (upgradeKey && wildjammerData.upgrades[upgradeKey]) {
                currentShip.addUpgrade(upgradeKey);
                applyUpgradeEffect(upgradeKey, true);
                updateUpgradesList();
                updateShipDisplay();
                saveShipChanges();
                hideUpgradeDropdown();
            } else {
                alert('Invalid upgrade selection');
            }
        }

        // Function to handle dark mode toggle
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
            updateDynamicClasses();
        }

        // Function to update dynamic classes based on current mode
        function updateDynamicClasses() {
            const isDarkMode = document.body.classList.contains('dark-mode');
            
            document.querySelectorAll('button, .magical-glow').forEach(element => {
                element.classList.toggle('dark-mode', isDarkMode);
                element.classList.toggle('light-mode', !isDarkMode);
            });
            
            document.querySelectorAll('.astral-text').forEach(element => {
                element.classList.toggle('dark-mode', isDarkMode);
                element.classList.toggle('light-mode', !isDarkMode);
            });
            
            document.querySelectorAll('input, select, textarea').forEach(element => {
                element.classList.toggle('dark-mode', isDarkMode);
                element.classList.toggle('light-mode', !isDarkMode);
            });

            document.querySelectorAll('.ship-card').forEach(element => {
                element.classList.toggle('dark-mode', isDarkMode);
                element.classList.toggle('light-mode', !isDarkMode);
            });
        }

        // Initialize the page
        function initializePage() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            document.body.classList.toggle('dark-mode', darkMode);
            document.body.classList.toggle('light-mode', !darkMode);
            updateDynamicClasses();
        }

        // Call initializePage when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializePage);

    </script>
</body>
</html>
